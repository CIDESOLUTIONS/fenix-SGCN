# ============================
# STAGE 1: Dependencias
# ============================
FROM node:18-alpine AS deps
WORKDIR /usr/src/app

# Crear usuario seguro
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copiar manifiestos de dependencias
COPY package*.json ./

# Instalar dependencias (con flags para evitar problemas de permisos)
RUN npm install --legacy-peer-deps --unsafe-perm

# Correcci칩n autom치tica de vulnerabilidades
RUN npm audit fix --force || true

# ============================
# STAGE 2: Desarrollo
# ============================
FROM node:18-alpine AS dev
WORKDIR /usr/src/app

# Crear usuario seguro
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copiar node_modules desde deps
COPY --from=deps /usr/src/app/node_modules ./node_modules

# Copiar todo el c칩digo del proyecto
COPY . .

# 游댐 Correcci칩n de permisos
RUN chown -R appuser:appgroup /usr/src/app

USER appuser

EXPOSE 3000
ENV PORT=3000

# Comando por defecto en modo dev
CMD ["npm", "run", "dev"]
