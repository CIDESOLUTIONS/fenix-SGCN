// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY Y USUARIOS
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  domain    String   @unique
  logo      String?
  colors    Json?
  
  // Sistema de suscripciÃ³n
  subscriptionPlan    SubscriptionPlan @default(TRIAL)
  subscriptionStatus  SubscriptionStatus @default(ACTIVE)
  trialEndsAt         DateTime?
  subscriptionEndsAt  DateTime?
  gracePeriodEndsAt   DateTime?  // 30 dÃ­as despuÃ©s de vencimiento
  
  // Backup y eliminaciÃ³n
  lastBackupAt        DateTime?
  backupUrl           String?    // URL del Ãºltimo backup
  scheduledDeletionAt DateTime?  // Fecha programada de eliminaciÃ³n
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users               User[]
  businessProcesses   BusinessProcess[]
  biaAssessments      BiaAssessment[]
  riskAssessments     RiskAssessment[]
  continuityStrategies ContinuityStrategy[]
  continuityPlans     ContinuityPlan[]
  testExercises       TestExercise[]
  complianceFrameworks ComplianceFramework[]
  correctiveActions   CorrectiveAction[]
  documents           Document[]
  auditLogs           AuditLog[]
  sgcnPolicies        SgcnPolicy[]
  sgcnObjectives      SgcnObjective[]
  raciMatrices        RaciMatrix[]
  findings            Finding[]
  exercises           Exercise[]
  businessContexts    BusinessContext[]
  swotAnalyses        SwotAnalysis[]

  @@map("tenants")
}

enum SubscriptionPlan {
  TRIAL          // 30 dÃ­as gratis
  STANDARD       // Plan bÃ¡sico
  PROFESSIONAL   // Plan profesional
  PREMIUM        // Plan premium
  ENTERPRISE     // Plan empresarial
}

enum SubscriptionStatus {
  ACTIVE         // Activa
  EXPIRED        // Vencida (en perÃ­odo de gracia)
  SUSPENDED      // Suspendida (no pago)
  CANCELLED      // Cancelada por usuario
  DELETED        // Eliminada (despuÃ©s de perÃ­odo de gracia)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String?
  position  String?
  phone     String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Preferencias de usuario
  locale      String?  @default("es")    // es, en, pt
  currency    String?  @default("COP")  // COP, USD, BRL
  theme       String?  @default("light") // light, dark, system

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
  AUDITOR
}

// ============================================
// AUDITORÃA Y LOGS
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String?
  action    String   // CREATE, UPDATE, DELETE, EXPORT, BACKUP
  entity    String   // Tenant, User, Document, etc.
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// ============================================
// MÃ“DULO: PROCESOS CRÃTICOS
// ============================================

model BusinessProcess {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  description      String?
  criticalityLevel CriticalityLevel
  department       String?
  dependencies     String[]
  responsiblePerson String?
  
  // Matriz RACI
  raciResponsible       String?
  raciResponsibleEmail  String?
  raciAccountable       String?
  raciAccountableEmail  String?
  raciConsulted         String?
  raciConsultedEmail    String?
  raciInformed          String?
  raciInformedEmail     String?
  
  // NUEVO: Caracterización de Alto Nivel
  highLevelCharacterization String?  @db.Text
  
  // NUEVO: Tipo de Proceso
  processType      ProcessType?
  
  // NUEVO: Inclusión en Análisis de Continuidad
  includeInContinuityAnalysis Boolean @default(false)
  
  // NUEVO: Criterios de Priorización (JSON con pesos)
  prioritizationCriteria Json?  // { strategic: 0-10, operational: 0-10, financial: 0-10, regulatory: 0-10 }
  
  // NUEVO: Score calculado de priorización
  priorityScore    Decimal? @db.Decimal(5, 2)
  
  // NUEVO: Archivo adjunto (caracterización completa)
  fileUrl          String?
  fileName         String?
  fileSize         Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  biaAssessments  BiaAssessment[]
  riskAssessments RiskAssessment[]
  strategies      ContinuityStrategy[]
  plans           ContinuityPlan[]

  @@map("business_processes")
}

enum CriticalityLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ProcessType {
  STRATEGIC    // Estratégico
  CORE         // Misional
  SUPPORT      // Soporte
}

// ============================================
// MÃ“DULO: BIA (Business Impact Analysis)
// ============================================

model BiaAssessment {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String
  
  // MÃ©tricas tiempo (en horas)
  rto         Int?     // Recovery Time Objective
  rpo         Int?     // Recovery Point Objective
  mtpd        Int?     // Maximum Tolerable Period of Disruption
  mbco        Decimal? // Minimum Business Continuity Objective
  
  // Impactos financieros
  financialImpact1h   Decimal?
  financialImpact24h  Decimal?
  financialImpact1w   Decimal?
  
  // Impactos cualitativos
  operationalImpact String?
  reputationImpact  String?
  regulatoryImpact  String?
  
  // Dependencias
  dependencyMap     Json?    // Grafo de dependencias
  
  // Scoring
  priorityScore     Decimal?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  process BusinessProcess @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@map("bia_assessments")
}

// ============================================
// MÃ“DULO: RIESGO DE CONTINUIDAD (ARA)
// ============================================

model RiskAssessment {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String?
  
  name        String
  description String?
  category    RiskCategory
  
  // EvaluaciÃ³n sin controles
  probabilityBefore Int      // 1-5
  impactBefore      Int      // 1-5
  scoreBefore       Decimal  // Calculado
  
  // Controles
  controls          String[]
  
  // EvaluaciÃ³n con controles
  probabilityAfter  Int?
  impactAfter       Int?
  scoreAfter        Decimal?
  
  // KRIs
  kris              Json?
  
  // Score resiliencia
  resilienceScore   Decimal?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  process BusinessProcess? @relation(fields: [processId], references: [id], onDelete: SetNull)

  @@map("risk_assessments")
}

enum RiskCategory {
  OPERATIONAL
  TECHNOLOGICAL
  NATURAL
  HUMAN
  EXTERNAL
}

// ============================================
// MÃ“DULO: ESCENARIOS Y ESTRATEGIAS
// ============================================

model ContinuityStrategy {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String?
  
  scenario    String
  description String?
  type        StrategyType
  
  // EvaluaciÃ³n
  cost              Decimal?
  effectiveness     Int?     // 1-5
  implementationTime Int?    // dÃ­as
  
  // Scoring
  costEffectivenessScore Decimal?
  
  recommended Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  process BusinessProcess? @relation(fields: [processId], references: [id], onDelete: SetNull)

  @@map("continuity_strategies")
}

enum StrategyType {
  PREVENTION
  MITIGATION
  RECOVERY
  REDUNDANCY
}

// ============================================
// MÃ“DULO: PLANES DE CONTINUIDAD
// ============================================

model ContinuityPlan {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String?
  
  name        String
  type        PlanType
  content     Json     // Editor visual blocks
  version     String   @default("1.0")
  
  // Estado
  status      PlanStatus @default(DRAFT)
  approvedBy  String?
  approvedAt  DateTime?
  
  // EjecuciÃ³n
  lastActivated DateTime?
  executionLog  Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  process BusinessProcess? @relation(fields: [processId], references: [id], onDelete: SetNull)
  testExercises TestExercise[]
  exercises Exercise[] @relation("ExercisePlan")

  @@map("continuity_plans")
}

enum PlanType {
  BCP  // Business Continuity Plan
  DRP  // Disaster Recovery Plan
  IRP  // Incident Response Plan
  CRISIS // Crisis Management Plan
}

enum PlanStatus {
  DRAFT
  REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
}

// ============================================
// MÃ“DULO: PRUEBAS DE CONTINUIDAD
// ============================================

model TestExercise {
  id          String   @id @default(uuid())
  tenantId    String
  planId      String?  // RelaciÃ³n con plan
  
  name        String
  type        TestType
  description String?
  scenario    Json?    // Escenario del ejercicio
  
  // PlanificaciÃ³n
  scheduledDate DateTime
  duration      Int?     // minutos planificados
  participants  String[]
  objectives    Json?    // Objetivos del ejercicio
  
  // EjecuciÃ³n
  executedDate     DateTime?
  executedBy       String?
  actualStartTime  DateTime?  // Hora real de inicio
  actualEndTime    DateTime?  // Hora real de fin
  actualDuration   Decimal?   // DuraciÃ³n real en horas
  executionLog     Json?      // Log de eventos
  
  // Resultados
  result        ExerciseResult?
  checklist     Json?
  results       String?
  score         Decimal?
  
  // Evidencias
  evidences     String[] // URLs MinIO
  
  // Lecciones aprendidas
  lessonsLearned String?
  improvements   String?
  
  // Reporte
  reportUrl     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   ContinuityPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@map("test_exercises")
}

enum TestType {
  DESKTOP
  FUNCTIONAL
  SIMULATION
  FULL_RECOVERY
}

// ============================================
// MÃ“DULO: CUMPLIMIENTO NORMATIVO
// ============================================

model ComplianceFramework {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String   // ISO 22301, ISO 31000, etc.
  version     String?
  description String?
  
  // CertificaciÃ³n
  certificationDate DateTime?
  expiryDate        DateTime?
  certifyingBody    String?
  certificateNumber String?
  
  // Estado
  complianceLevel   Decimal? // 0-100%
  lastAssessment    DateTime?
  nextAssessment    DateTime?
  
  requirements Json?   // Requisitos detallados
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("compliance_frameworks")
}

// ============================================
// MÃ“DULO: MEJORA CONTINUA
// ============================================

model CorrectiveAction {
  id          String   @id @default(uuid())
  tenantId    String
  
  title       String
  description String?
  category    ActionCategory
  
  // NC/Hallazgo (relaciÃ³n con Finding)
  findingId   String?
  finding     Finding? @relation(fields: [findingId], references: [id], onDelete: SetNull)
  severity    Severity
  
  // Plan de acciÃ³n
  actionPlan  String
  responsible String
  assignedTo  String?  // Para workflows
  targetDate  DateTime?  // Para workflows
  dueDate     DateTime
  
  // Estado
  status      ActionStatus @default(OPEN)
  
  // Cierre
  verification String?
  completedDate DateTime?
  closedBy     String?
  closedAt     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("corrective_actions")
}

enum ActionCategory {
  AUDIT_FINDING
  INCIDENT
  EXERCISE_RESULT
  IMPROVEMENT
}

enum Severity {
  CRITICAL
  MAJOR
  MINOR
}

enum ActionStatus {
  OPEN
  IN_PROGRESS
  PENDING_VERIFICATION
  COMPLETED
  CLOSED
}

// ============================================
// HALLAZGOS (FINDINGS)
// ============================================

model Finding {
  id          String   @id @default(uuid())
  tenantId    String
  
  title       String
  description String   @db.Text
  source      FindingSource
  sourceReference String?  // ID del ejercicio, auditorÃ­a, etc.
  severity    Severity
  category    String
  
  // Impacto y recomendaciÃ³n
  affectedArea    String?
  impact          String?  @db.Text
  recommendation  String?  @db.Text
  
  // Estado
  status      FindingStatus @default(OPEN)
  
  // ResoluciÃ³n
  resolution  String?  @db.Text
  resolvedBy  String?
  resolvedAt  DateTime?
  
  // AuditorÃ­a
  identifiedBy String
  identifiedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  correctiveActions CorrectiveAction[]

  @@map("findings")
}

enum FindingSource {
  AUDIT
  EXERCISE
  INCIDENT
  REVIEW
  SELF_ASSESSMENT
  RISK_ASSESSMENT
  MANAGEMENT_REVIEW
  STAKEHOLDER_FEEDBACK
}

enum FindingStatus {
  OPEN
  IN_REVIEW
  ACTION_PLAN
  RESOLVED
  VERIFIED
  CLOSED
}

// ============================================
// EJERCICIOS (EXERCISES)
// ============================================

model Exercise {
  id          String   @id @default(uuid())
  tenantId    String
  
  // InformaciÃ³n bÃ¡sica
  name        String
  type        ExerciseType
  description String?  @db.Text
  
  // PlanificaciÃ³n
  scheduledDate DateTime
  planId      String?
  scenario    Json?    // Escenario del ejercicio
  
  // EjecuciÃ³n
  startTime   DateTime?
  endTime     DateTime?
  actualEndTime DateTime?  // Alias para exercises.service.ts
  status      ExerciseStatus @default(PLANNED)
  
  // Resultados
  result      ExerciseResult?
  score       Decimal?         @db.Decimal(5, 2)
  
  // Tiempos y duraciÃ³n
  actualStartTime DateTime?
  actualDuration  Float?     // DuraciÃ³n real en horas
  
  // Objetivos y log de ejecuciÃ³n
  objectives     Json?      // Array de objetivos del ejercicio
  executionLog   Json?      // Log completo de eventos durante ejercicio
  
  // Observaciones
  observations String?  @db.Text
  gaps        Json?    // Array de brechas identificadas
  
  // Evidencias
  evidences   Json?    // Array de URLs de evidencias (fotos, videos)
  
  // Participantes
  participants String[]
  facilitator  String
  
  // Reporte
  reportUrl    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   ContinuityPlan? @relation("ExercisePlan", fields: [planId], references: [id], onDelete: SetNull)

  @@map("exercises")
}

enum ExerciseType {
  TABLETOP      // Ejercicio de mesa
  WALKTHROUGH   // RevisiÃ³n paso a paso
  SIMULATION    // SimulaciÃ³n
  FULL_SCALE    // Prueba a escala completa
  DRILL         // Simulacro
}

enum ExerciseStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ExerciseResult {
  SUCCESS
  SUCCESS_WITH_OBSERVATIONS
  PARTIAL_SUCCESS
  FAILED
}

// ============================================
// REPOSITORIO DOCUMENTAL
// ============================================

model Document {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  type        DocumentType
  category    String?
  
  // Storage
  fileUrl     String   // MinIO URL
  fileSize    Int?     // bytes
  mimeType    String?
  
  // Metadata
  version     String   @default("1.0")
  tags        String[]
  description String?
  
  // Control
  approvedBy  String?
  approvedAt  DateTime?
  expiryDate  DateTime?
  
  // Legal hold
  legalHold   Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("documents")
}

enum DocumentType {
  POLICY
  PROCEDURE
  PLAN
  REPORT
  EVIDENCE
  CERTIFICATE
  OTHER
}

// ============================================
// MÃ“DULO 1: PLANEACIÃ“N Y GOBIERNO (ISO 22301 ClÃ¡usula 5)
// ============================================

model SgcnPolicy {
  id          String   @id @default(uuid())
  tenantId    String
  
  title       String
  content     String   @db.Text
  version     String   @default("1.0")
  
  status      PolicyStatus @default(DRAFT)
  
  // AprobaciÃ³n
  approvedBy  String?
  approvedAt  DateTime?
  
  // PublicaciÃ³n
  publishedBy String?
  publishedAt DateTime?
  
  // AuditorÃ­a
  createdBy   String
  updatedBy   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sgcn_policies")
}

enum PolicyStatus {
  DRAFT
  REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
}

model SgcnObjective {
  id                  String   @id @default(uuid())
  tenantId            String
  
  description         String
  measurementCriteria String
  targetDate          DateTime?
  owner               String
  
  status              ObjectiveStatus @default(NOT_STARTED)
  progress            Int?     @default(0) // 0-100%
  
  createdBy           String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sgcn_objectives")
}

enum ObjectiveStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  COMPLETED
}

model RaciMatrix {
  id                String   @id @default(uuid())
  tenantId          String
  
  processOrActivity String
  assignments       Json     // Array de { role, responsibility, raciType }
  
  createdBy         String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("raci_matrices")
}


// ============================================
// CONTEXTO DE NEGOCIO Y ANÁLISIS FODA
// ============================================

model BusinessContext {
  id              String   @id @default(uuid())
  tenantId        String
  
  // Información básica
  title           String
  description     String?  @db.Text
  elaborationDate DateTime @default(now())
  
  // Contenido
  content         String   @db.Text
  
  // Archivo adjunto
  fileUrl         String?  // URL del PDF/documento original
  fileName        String?
  fileSize        Int?
  
  // Estado y aprobación
  status          PolicyStatus @default(DRAFT)
  approvedBy      String?
  approvedAt      DateTime?
  
  // Auditoría
  createdBy       String
  updatedBy       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  swotAnalyses SwotAnalysis[]

  @@map("business_contexts")
}

model SwotAnalysis {
  id              String   @id @default(uuid())
  tenantId        String
  contextId       String   // Relación con BusinessContext
  
  // Información básica
  title           String
  description     String?
  analysisDate    DateTime @default(now())
  
  // FODA
  strengths       Json     // Array de fortalezas
  weaknesses      Json     // Array de debilidades
  opportunities   Json     // Array de oportunidades
  threats         Json     // Array de amenazas
  
  // Estrategias derivadas
  strategies      Json?    // Array de estrategias FO, FA, DO, DA
  
  // Participantes
  participants    String[] // Array de nombres/emails
  facilitator     String
  
  // Estado
  status          SwotStatus @default(IN_PROGRESS)
  
  // Auditoría
  createdBy       String
  updatedBy       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  context BusinessContext @relation(fields: [contextId], references: [id], onDelete: Cascade)

  @@map("swot_analyses")
}

enum SwotStatus {
  IN_PROGRESS
  COMPLETED
  APPROVED
  ARCHIVED
}
